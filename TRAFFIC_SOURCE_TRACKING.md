# Traffic Source Tracking Implementation

## Overview
This document describes the traffic source tracking system implemented to identify whether users come from **Meta Ads** (Facebook/Instagram), **Google Ads**, **Organic Search**, or **Direct** traffic.

## How It Works

### 1. Detection Priority (2025/2026 Best Practices)
The system uses a multi-layered approach to detect traffic sources:

1. **Next.js useSearchParams** (Most Reliable)
   - Uses `useSearchParams()` hook from Next.js App Router
   - Properly handles Suspense boundaries for server rendering
   - Reads `utm_source`, `utm_medium`, `utm_campaign`, `utm_content`, `utm_term`
   
2. **Click IDs** (Auto-generated by Ad Platforms)
   - `gclid` (Google Click ID) - Automatically added by Google Ads
   - `fbclid` (Facebook Click ID) - Automatically added by Meta Ads
   - Note: Safari may strip these in Private Browsing mode
   
3. **Referrer** (Fallback)
   - Detects organic traffic from facebook.com, instagram.com, google.com, etc.
   - Safari also strips tracking data from referrers but domain detection still works

### 2. Storage Strategy
The system uses triple-redundant storage to ensure data persists:

- **SessionStorage**: Primary storage for current session
- **LocalStorage**: Backup for longer-term persistence (30 days)
- **Cookies**: Fallback (30-day expiry, SameSite=Lax)

Data is stored immediately when tracking params are detected and retrieved on subsequent page loads.

### 3. Source Classification

#### Meta Ads Detection
Identifies as "Meta Ads" when:
- `fbclid` parameter is present
- `utm_source` contains: facebook, fb, instagram, ig, meta

#### Google Ads Detection
Identifies as "Google Ads" when:
- `gclid` parameter is present
- `utm_source` contains "google" AND `utm_medium` is "cpc", "ppc", or "paid"

#### Organic Traffic
Identified when:
- Referrer from: facebook.com, instagram.com, google.com, bing.com, yahoo.com
- No ad-related tracking parameters

#### Other Sources
- LinkedIn: `utm_source` contains "linkedin"
- Twitter/X: `utm_source` contains "twitter" or "x.com"
- TikTok: `utm_source` contains "tiktok"
- Email: `utm_source` contains "email" or "newsletter"
- Custom UTM sources are shown as-is

#### Direct Traffic
Identified when none of the above conditions are met.

## Implementation Details

### Files

1. **`src/hooks/useTrafficSource.ts`**
   - Main React hook that detects and tracks traffic source
   - Uses Next.js `useSearchParams()` for reliable param detection
   - Handles storage with triple-redundant fallbacks
   - Returns complete traffic source data

2. **`src/app/page.tsx`**
   - Uses `useTrafficSource` hook inside Suspense boundary
   - Tags Clarity session with traffic source info
   - Includes traffic source in all API calls

3. **`src/lib/googleChatWebhook.ts`**
   - Displays traffic source in Google Chat notifications
   - Shows emoji icons for different sources (ðŸ“˜ Meta, ðŸ” Google, ðŸ”— Direct, etc.)
   - Includes campaign, medium, and source details when available

## Data Flow

1. User lands on the site with tracking parameters (e.g., `?utm_source=facebook&utm_campaign=spring2026`)
2. `useTrafficSource` hook (wrapped in Suspense) reads params via `useSearchParams()`
3. Traffic source is detected and stored in localStorage/sessionStorage/cookies
4. Clarity session is tagged with traffic source for analytics segmentation
5. When user submits the form, traffic source is included in:
   - Initial estimate API call (`/api/v1/init_estimates`)
   - Final submission API call (`/api/v1/submit_estimate`)
   - Google Chat notifications (both incomplete and complete)

## Example Data Structures

### Traffic Source Data Object
```typescript
{
  source: "Meta Ads",           // Detected source name
  utmSource: "facebook",        // Original utm_source value
  utmMedium: "cpc",            // Original utm_medium value
  utmCampaign: "spring2026",   // Original utm_campaign value
  utmContent: "ad_variant_a",  // Original utm_content value
  utmTerm: "app_development",  // Original utm_term value
  gclid: null,                 // Google Click ID (if present)
  fbclid: "IwAR123...",        // Facebook Click ID (if present)
  referrer: "https://...",     // Original referrer URL
  landingPage: "https://..."   // Landing page URL
}
```

### API Payload Format
```json
{
  "contact": { ... },
  "trafficSource": {
    "source": "Meta Ads",
    "utmSource": "facebook",
    "utmMedium": "cpc",
    "utmCampaign": "spring2026",
    "gclid": null,
    "fbclid": "IwAR123..."
  }
}
```

### Google Chat Notification Format
The notification shows:
```
ðŸ“˜ Meta Ads (Facebook/Instagram)
â€¢ Campaign: spring2026
â€¢ Medium: cpc
â€¢ Source: facebook
```

## Testing

### Test URLs

**Meta Ads:**
```
https://yoursite.com?utm_source=facebook&utm_medium=cpc&utm_campaign=test_campaign
https://yoursite.com?fbclid=IwAR123456789
```

**Google Ads:**
```
https://yoursite.com?utm_source=google&utm_medium=cpc&utm_campaign=test_campaign
https://yoursite.com?gclid=Cj0KCQiAw-blBRCvARIsAIfODmV
```

**Direct:**
```
https://yoursite.com
```

### Debug Console Output

Open browser console to see detailed logging:
```
ðŸš€ Traffic Source Hook Initializing...
ðŸ“ Current URL: https://yoursite.com?utm_source=facebook&utm_medium=cpc
ðŸ“ Search params from Next.js: utm_source=facebook&utm_medium=cpc
ðŸ“ Referrer: 
ðŸ“Š Tracking params found: {utmSource: "facebook", utmMedium: "cpc", ...}
ðŸ” Detecting source from: {utmSource: "facebook", utmMedium: "cpc", ...}
âœ¨ Detected: Meta Ads (via utm_source)
âœ… Fresh tracking data captured: {...}
ðŸ·ï¸ Tagged Clarity session with traffic source: Meta Ads
```

### Clear Stored Tracking (for testing)

In browser console:
```javascript
// Import the clear function
import { clearTrafficSource } from '@/hooks/useTrafficSource';
clearTrafficSource();

// Or manually clear storage:
localStorage.removeItem('tecaudex_traffic_source');
sessionStorage.removeItem('tecaudex_traffic_source');
document.cookie = 'tecaudex_traffic_source=; path=/; max-age=0';
```

## Privacy & Compliance

- Traffic source data is stored locally in the user's browser only
- Data is only sent to your own API endpoints and Google Chat webhook
- No third-party tracking services receive this data
- Users can clear this data by clearing browser storage/cookies

## Microsoft Clarity Integration

The traffic source is automatically tagged in Clarity:
- `traffic_source`: Main source (Meta Ads, Google Ads, Direct, etc.)
- `utm_source`: Original UTM source value
- `utm_medium`: Original UTM medium value
- `utm_campaign`: Original UTM campaign value
- `has_gclid`: "true" if Google Click ID was present
- `has_fbclid`: "true" if Facebook Click ID was present

These tags help segment user behavior by traffic source in your Clarity dashboard.

## Troubleshooting

### Issue: Always showing "Direct"

1. **Check URL parameters**: Ensure tracking params are in the URL when landing
2. **Check Suspense boundary**: The hook must be used inside a Suspense boundary
3. **Check storage**: Open DevTools > Application > Storage to verify data is saved
4. **Check console logs**: Look for the ðŸš€ and âœ… emojis to verify detection

### Issue: Params not captured on first load

The hook uses Next.js `useSearchParams()` which requires a Suspense boundary. Ensure `HomeContent` (or the component using the hook) is wrapped in `<Suspense>`.

### Issue: Storage cleared unexpectedly

- Private browsing may clear storage when browser closes
- Some ad blockers may interfere with storage
- Cookie consent tools may clear tracking cookies

## Maintenance Notes

- Storage expires: Cookies and localStorage after 30 days
- Attribution model: First-touch (preserves the original traffic source throughout the session)
- The system gracefully falls back if storage is unavailable or blocked
- Build verified: âœ… Production build successful with no errors
